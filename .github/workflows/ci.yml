name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['3.2', '3.3', '3.4']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby ${{ matrix.ruby-version }}
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Run RuboCop
      run: bundle exec rubocop --config .rubocop.yml
      env:
        RUBOCOP_OPTS: "--config .rubocop.yml"

    - name: Run RSpec tests
      run: bundle exec rspec 2>&1 | grep -v "unicode_utils"

    - name: Check gem build
      run: gem build kiket-cli.gemspec

  integration:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Build and install gem locally
      run: |
        gem build kiket-cli.gemspec
        gem install ./kiket-cli-*.gem

    - name: Test CLI installation
      run: |
        kiket version
        kiket help

  extension-suite:
    runs-on: ubuntu-latest
    needs: integration
    env:
      KIKET_API_TOKEN: dummy-token

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Set up Python toolchain
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install lint/test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest ruff

    - name: Run extension CLI workflow
      run: |
        bundle exec exe/kiket extensions scaffold sample-extension \
          --sdk python \
          --template webhook_guard \
          --force
        bundle exec exe/kiket extensions lint sample-extension
        bundle exec exe/kiket extensions test sample-extension
        bundle exec exe/kiket extensions replay \
          --template before_transition \
          --url https://httpbin.org/post
